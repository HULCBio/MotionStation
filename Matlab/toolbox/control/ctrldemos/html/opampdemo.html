<!--
This HTML is auto-generated from an m-file.
Your changes will be overwritten.
--><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:x-large">Feedback Amplifier Demo</p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">This demo demonstrates the design of a non-inverting feedback
amplifier circuit using the Control System Toolbox.  This design
is built around the operational amplifier (op amp), a standard
building block of electrical feedback circuits.
</p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">This tutorial demonstrates how a real electrical system can be
designed, modeled, and analyzed using the tools provided by the
Control System Toolbox.
</p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Authors: A. DiVergilio
Copyright 1986-2002 The MathWorks, Inc.
$Revision: 1.9 $  $Date: 2002/04/08 16:22:23 $
</p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">The standard building block of electrical feedback circuits is
the operational amplifier (op amp), a differential voltage
amplifier designed to have extremely high dc gain, often in
the range of 1e5 to 1e7.
</p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">The electrical symbol for the op amp is shown above.
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(1)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img02.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">This demo assumes the use of an uncompensated op amp with 2
poles (at frequencies w1,w2) and high dc gain (a0).  Assuming
this op amp is operated in its linear mode (not saturated),
then its open-loop transfer function can be represented as a
linear time-invariant (LTI) system, as shown above.
</p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Though higher-order poles will exist in a physical op amp, it
has been assumed in this case that these poles lie in a frequency
range where the magnitude has dropped well below unity.
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(2)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img03.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">The following system parameters are assumed:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; a0 = 1e5;
 &gt;&gt; w1 = 1e4;
 &gt;&gt; w2 = 1e6;
</pre><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Next, you want to create a transfer function model of this system
using the Control System Toolbox.  This model will be stored in
the MATLAB workspace as an LTI object.
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(3)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img04.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">First, define the Laplace variable, s, using the TF command.  Then
use 's' to construct the open-loop transfer function, a(s):
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; s = tf('s');
 &gt;&gt; a = a0/(1+s/w1)/(1+s/w2)
</pre><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> Transfer function:
           100000
 --------------------------
 1e-10 s^2 + 0.000101 s + 1
</pre><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(4)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img05.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">You can view the frequency response of a(s) using the BODE command:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; bode(a,'r')
</pre><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Right-click on the plot to access a menu of properties for this
Bode Diagram.  Left-click on the curves to create moveable data
markers which can be used to obtain response details.
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(5)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img06.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">You can view the normalized step response of a(s) using the STEP
and DCGAIN commands:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; a_norm = a / dcgain(a);
 &gt;&gt; step(a_norm,'r')
</pre><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Right-click on the plot and select "Characteristics -&gt; Settling Time"
to display the settling time. Hold the mouse over the settling time
marker to reveal the exact value of the settling time.
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(6)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img07.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Now add a resistive feedback network and wire the system as a
non-inverting amplifier.
</p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">This feedback network, b(s), is simply a voltage divider with
input Vo and output Vn.  Solving for the ratio Vn/Vo yields the
transfer function for b(s):
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">      b  =  Vn / Vo  =  R1 / (R1 + R2)
</pre><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(7)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img08.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">The block diagram representation of the system is shown above.
</p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Solving for the ratio Vo/Vp yields the closed-loop gain, A(s):
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">      A  =  Vo / Vp  =  a / (1 + ab)
</pre><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">If the product 'ab' is sufficiently large (&gt;&gt;1), then A(s) may
be approximated as
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">      A  =  1 / b
</pre><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(8)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img09.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Now assume that you need to design an amplifier of dc gain 10 and
that R1 is fixed at 10 kOhm.  Solving for R2 yields:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; A0 = 10;
 &gt;&gt; b = 1 / A0;    % approximation for ab&gt;&gt;1
 &gt;&gt; R1 = 10000;
 &gt;&gt; R2 = R1 * (1/b - 1)
</pre><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> R2 =
            90000
</pre><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(9)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img10.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Construct the closed-loop system using the FEEDBACK command:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; A = feedback(a,b);
</pre><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Next, plot the frequency responses of a(s) and A(s) together
using the BODE command:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; bode(a,'r',A,'b')
</pre><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(10)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img11.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">The use of negative feedback to reduce the low-frequency (LF) gain
has led to a corresponding increase in the system bandwidth (defined
as the frequency where the gain drops 3dB below its maximum value).
</p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">This gain / bandwidth tradeoff is a powerful tool in the design of
feedback amplifier circuits.
</p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Since the gain is now dominated by the feedback network, a useful
relationship to consider is the sensitivity of this gain to
variation in the op amp's natural (open-loop) gain.
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(11)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img12.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Before deriving the system sensitivity, however, it is useful to
define the loop gain, L(s), which is the total gain a signal
experiences traveling around the loop:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; L = a * b;
</pre><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">You will use this quantity to evaluate the system sensitivity
and stability margins.
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(12)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img13.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">The system sensitivity, S(s), represents the sensitivity of A(s) to
variation in a(s).  The inverse relationship between S(s) and L(s)
reveals another benefit of negative feedback: "gain desensitivity".
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; S = 1 / (1 + L);
</pre><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">S(s) has the same form as the feedback equation and, therefore, may
be constructed using the more-robust FEEDBACK command:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; S = feedback(1,L);
</pre><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(13)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img14.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">The magnitudes of S(s) and A(s) may be plotted together using the
BODEMAG command:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; bodemag(A,'b',S,'g')
</pre><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">The very small low-frequency sensitivity (about -80 dB) indicates
a design whose closed-loop gain suffers minimally from open-loop
gain variation.  Such variation in a(s) is common due to
manufacturing variability, temperature change, etc.
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(14)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img15.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">You can check the step response of A(s) using the STEP command:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; step(A)
</pre><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Note that the use of feedback has greatly reduced the settling
time (by about 98%).  However, the step response now displays
a large amount of ringing, indicating poor stability margin.
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(15)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img16.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">You can analyze the stability margin by plotting the loop gain,
L(s), with the MARGIN command:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; margin(L)
</pre><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">The resulting plot indicates a phase margin of less than 6 degrees.
You will need to compensate this amplifier in order to raise the
phase margin to an acceptable level (generally 45 deg or more),
thus reducing excessive overshoot and ringing.
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(16)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img17.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">A commonly used method of compensation in this type of circuit is
"feedback lead compensation".  This technique modifies b(s) by
adding a capacitor, C, in parallel with the feedback resistor, R2.
</p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">The capacitor value is chosen so as to introduce a phase lead to
b(s) near the crossover frequency, thus increasing the amplifier's
phase margin.
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(17)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img18.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">The new feedback transfer function is shown above.
</p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">You can approximate a value for C by placing the zero of b(s) at
the 0dB crossover frequency of L(s):
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; [Gm,Pm,Wcg,Wcp] = margin(L);
 &gt;&gt; C = 1/(R2*Wcp)
</pre><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> C =
            1.1139e-12
</pre><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(18)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img19.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">To study the effect of C on the amplifier response, create an LTI
model array of b(s) for several values of C around your initial
guess:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; K = R1/(R1+R2);
 &gt;&gt; C = [1:.2:3]*1e-12;
 &gt;&gt; for n = 1:length(C)
         b_array(:,:,n) = tf([K*R2*C(n) K],[K*R2*C(n) 1]);
      end
</pre><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(19)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img20.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Now you can create LTI arrays for A(s) and L(s):
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; A_array = feedback(a,b_array);
 &gt;&gt; L_array = a*b_array;
</pre><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">You can plot the step response of all models in the LTI array,
A_array(s), together with A(s) using the STEP command:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; step(A,'b:',A_array,'b');
</pre><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(20)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img21.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">The phase margins for our loop gain array, L_array(s), are found
using the MARGIN command:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; [Gm,Pm,Wcg,Wcp] = margin(L_array);
</pre><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">The phase margins may now be plotted as a function of C:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; plot(C*1e12,Pm,'g');
</pre><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">A maximum phase margin of 58 deg is obtained when C=2pF (2e-12).
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(21)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img22.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">The model corresponding to C=2pF is the sixth model in the LTI
array, b_array(s).  You can plot the step response of the closed-
loop system for this model by selecting index 6 of the LTI array
A_array(s):
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; A_comp = A_array(:,:,6);
 &gt;&gt; step(A,'b:',A_comp,'b')
</pre><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Note that the settling time has been further reduced (by an
additional 85%).
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(22)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img23.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">We can overlay the frequency-response of all three models
(open-loop, closed-loop,compensated closed-loop) using the
BODE command:
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"> &gt;&gt; bode(a,'r',A,'b:',A_comp,'b')
</pre><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">Note how the addition of the compensation capacitor has
eliminated peaking in the closed-loop gain and also greatly
extended the phase margin.
</p><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(23)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img24.gif"><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="color:#990000; font-weight:bold; font-size:medium; page-break-before: auto;"><a name=""></a></p><p xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">A brief summary of the choice of component values in the design
of this non-inverting feedback amplifier circuit:
</p><ul xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"><li> resistive feedback network (R1,R2) was selected to yield a
   broadband amplifier gain of 10 (20 dB).
</li></ul><ul xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"><li>eedback lead compensation was used to tune the loop gain near
   near the crossover frequency.  The value for the compensation
   capacitor, C, was optimized to provide a maximum phase margin
   of about 58 degrees.
</li></ul><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" style="position: relative; left:30px">opampdemo_aux(24)</pre><img xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" src="opampdemo_img25.gif"><originalCode xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd" code="%% Feedback Amplifier Demo&#xA;% This demo demonstrates the design of a non-inverting feedback&#xA;% amplifier circuit using the Control System Toolbox.  This design&#xA;% is built around the operational amplifier (op amp), a standard&#xA;% building block of electrical feedback circuits.&#xA;%&#xA;% This tutorial demonstrates how a real electrical system can be&#xA;% designed, modeled, and analyzed using the tools provided by the&#xA;% Control System Toolbox.&#xA;%&#xA;% Authors: A. DiVergilio&#xA;% Copyright 1986-2002 The MathWorks, Inc.&#xA;% $Revision: 1.9 $  $Date: 2002/04/08 16:22:23 $&#xA;&#xA;%%&#xA;% The standard building block of electrical feedback circuits is&#xA;% the operational amplifier (op amp), a differential voltage&#xA;% amplifier designed to have extremely high dc gain, often in&#xA;% the range of 1e5 to 1e7.&#xA;% &#xA;% The electrical symbol for the op amp is shown above.&#xA;&#xA;opampdemo_aux(1)&#xA;&#xA;%%&#xA;% This demo assumes the use of an uncompensated op amp with 2&#xA;% poles (at frequencies w1,w2) and high dc gain (a0).  Assuming&#xA;% this op amp is operated in its linear mode (not saturated), &#xA;% then its open-loop transfer function can be represented as a&#xA;% linear time-invariant (LTI) system, as shown above.&#xA;% &#xA;% Though higher-order poles will exist in a physical op amp, it&#xA;% has been assumed in this case that these poles lie in a frequency&#xA;% range where the magnitude has dropped well below unity.&#xA;&#xA;opampdemo_aux(2)&#xA;&#xA;&#xA;%%&#xA;% The following system parameters are assumed:&#xA;% &#xA;%  &gt;&gt; a0 = 1e5;&#xA;%  &gt;&gt; w1 = 1e4;&#xA;%  &gt;&gt; w2 = 1e6;&#xA;%  &#xA;% Next, you want to create a transfer function model of this system&#xA;% using the Control System Toolbox.  This model will be stored in&#xA;% the MATLAB workspace as an LTI object.&#xA;&#xA;opampdemo_aux(3)&#xA;&#xA;&#xA;%%&#xA;% First, define the Laplace variable, s, using the TF command.  Then&#xA;% use 's' to construct the open-loop transfer function, a(s):&#xA;% &#xA;%  &gt;&gt; s = tf('s');          &#xA;%  &gt;&gt; a = a0/(1+s/w1)/(1+s/w2)&#xA;%                             &#xA;%  Transfer function:         &#xA;%            100000           &#xA;%  -------------------------- &#xA;%  1e-10 s^2 + 0.000101 s + 1 &#xA;&#xA;opampdemo_aux(4)&#xA;&#xA;%%&#xA;% You can view the frequency response of a(s) using the BODE command:&#xA;% &#xA;%  &gt;&gt; bode(a,'r')&#xA;%  &#xA;% Right-click on the plot to access a menu of properties for this&#xA;% Bode Diagram.  Left-click on the curves to create moveable data&#xA;% markers which can be used to obtain response details.&#xA;&#xA;opampdemo_aux(5)&#xA;&#xA;%%&#xA;% You can view the normalized step response of a(s) using the STEP&#xA;% and DCGAIN commands:&#xA;% &#xA;%  &gt;&gt; a_norm = a / dcgain(a);&#xA;%  &gt;&gt; step(a_norm,'r')&#xA;%  &#xA;% Right-click on the plot and select &#34;Characteristics -&gt; Settling Time&#34;&#xA;% to display the settling time. Hold the mouse over the settling time&#xA;% marker to reveal the exact value of the settling time.&#xA;&#xA;opampdemo_aux(6)&#xA;&#xA;%%&#xA;% Now add a resistive feedback network and wire the system as a&#xA;% non-inverting amplifier.&#xA;% &#xA;% This feedback network, b(s), is simply a voltage divider with&#xA;% input Vo and output Vn.  Solving for the ratio Vn/Vo yields the&#xA;% transfer function for b(s):&#xA;% &#xA;%       b  =  Vn / Vo  =  R1 / (R1 + R2) &#xA;&#xA;opampdemo_aux(7)&#xA;&#xA;%%&#xA;% The block diagram representation of the system is shown above.&#xA;% &#xA;% Solving for the ratio Vo/Vp yields the closed-loop gain, A(s):&#xA;% &#xA;%       A  =  Vo / Vp  =  a / (1 + ab)&#xA;%  &#xA;% If the product 'ab' is sufficiently large (&gt;&gt;1), then A(s) may&#xA;% be approximated as&#xA;% &#xA;%       A  =  1 / b&#xA;&#xA;opampdemo_aux(8)&#xA;&#xA;%%&#xA;% Now assume that you need to design an amplifier of dc gain 10 and&#xA;% that R1 is fixed at 10 kOhm.  Solving for R2 yields:&#xA;% &#xA;%  &gt;&gt; A0 = 10;&#xA;%  &gt;&gt; b = 1 / A0;    % approximation for ab&gt;&gt;1&#xA;%  &gt;&gt; R1 = 10000;&#xA;%  &gt;&gt; R2 = R1 * (1/b - 1)&#xA;%  &#xA;%  R2 = &#xA;%             90000&#xA;&#xA;opampdemo_aux(9)&#xA;&#xA;%%&#xA;% Construct the closed-loop system using the FEEDBACK command:&#xA;% &#xA;%  &gt;&gt; A = feedback(a,b);&#xA;%  &#xA;% Next, plot the frequency responses of a(s) and A(s) together&#xA;% using the BODE command:&#xA;% &#xA;%  &gt;&gt; bode(a,'r',A,'b')&#xA;&#xA;opampdemo_aux(10)&#xA;&#xA;%%&#xA;% The use of negative feedback to reduce the low-frequency (LF) gain&#xA;% has led to a corresponding increase in the system bandwidth (defined&#xA;% as the frequency where the gain drops 3dB below its maximum value).&#xA;% &#xA;% This gain / bandwidth tradeoff is a powerful tool in the design of&#xA;% feedback amplifier circuits.&#xA;% &#xA;% Since the gain is now dominated by the feedback network, a useful&#xA;% relationship to consider is the sensitivity of this gain to&#xA;% variation in the op amp's natural (open-loop) gain.&#xA;&#xA;opampdemo_aux(11)&#xA;&#xA;%%&#xA;% Before deriving the system sensitivity, however, it is useful to&#xA;% define the loop gain, L(s), which is the total gain a signal&#xA;% experiences traveling around the loop:&#xA;% &#xA;%  &gt;&gt; L = a * b;&#xA;% &#xA;% You will use this quantity to evaluate the system sensitivity&#xA;% and stability margins.&#xA;&#xA;opampdemo_aux(12)&#xA;&#xA;%%&#xA;% The system sensitivity, S(s), represents the sensitivity of A(s) to&#xA;% variation in a(s).  The inverse relationship between S(s) and L(s)&#xA;% reveals another benefit of negative feedback: &#34;gain desensitivity&#34;.&#xA;% &#xA;%  &gt;&gt; S = 1 / (1 + L);&#xA;% &#xA;% S(s) has the same form as the feedback equation and, therefore, may&#xA;% be constructed using the more-robust FEEDBACK command:&#xA;% &#xA;%  &gt;&gt; S = feedback(1,L);&#xA;&#xA;opampdemo_aux(13)&#xA;&#xA;%%&#xA;% The magnitudes of S(s) and A(s) may be plotted together using the&#xA;% BODEMAG command:&#xA;% &#xA;%  &gt;&gt; bodemag(A,'b',S,'g')&#xA;%  &#xA;% The very small low-frequency sensitivity (about -80 dB) indicates&#xA;% a design whose closed-loop gain suffers minimally from open-loop&#xA;% gain variation.  Such variation in a(s) is common due to &#xA;% manufacturing variability, temperature change, etc.&#xA;&#xA;opampdemo_aux(14)&#xA;&#xA;%%&#xA;% You can check the step response of A(s) using the STEP command:&#xA;% &#xA;%  &gt;&gt; step(A)&#xA;% &#xA;% Note that the use of feedback has greatly reduced the settling&#xA;% time (by about 98%).  However, the step response now displays&#xA;% a large amount of ringing, indicating poor stability margin.&#xA;&#xA;opampdemo_aux(15)&#xA;&#xA;%%&#xA;% You can analyze the stability margin by plotting the loop gain,&#xA;% L(s), with the MARGIN command:&#xA;% &#xA;%  &gt;&gt; margin(L)&#xA;% &#xA;% The resulting plot indicates a phase margin of less than 6 degrees.&#xA;% You will need to compensate this amplifier in order to raise the&#xA;% phase margin to an acceptable level (generally 45 deg or more),&#xA;% thus reducing excessive overshoot and ringing.&#xA;&#xA;opampdemo_aux(16)&#xA;&#xA;%%&#xA;% A commonly used method of compensation in this type of circuit is&#xA;% &#34;feedback lead compensation&#34;.  This technique modifies b(s) by&#xA;% adding a capacitor, C, in parallel with the feedback resistor, R2.&#xA;% &#xA;% The capacitor value is chosen so as to introduce a phase lead to&#xA;% b(s) near the crossover frequency, thus increasing the amplifier's&#xA;% phase margin.&#xA;&#xA;opampdemo_aux(17)&#xA;&#xA;%%&#xA;% The new feedback transfer function is shown above.&#xA;% &#xA;% You can approximate a value for C by placing the zero of b(s) at&#xA;% the 0dB crossover frequency of L(s):&#xA;% &#xA;%  &gt;&gt; [Gm,Pm,Wcg,Wcp] = margin(L);&#xA;%  &gt;&gt; C = 1/(R2*Wcp)&#xA;%  &#xA;%  C = &#xA;%             1.1139e-12&#xA;&#xA;opampdemo_aux(18)&#xA;&#xA;%%&#xA;% To study the effect of C on the amplifier response, create an LTI&#xA;% model array of b(s) for several values of C around your initial&#xA;% guess:&#xA;% &#xA;%  &gt;&gt; K = R1/(R1+R2);&#xA;%  &gt;&gt; C = [1:.2:3]*1e-12;&#xA;%  &gt;&gt; for n = 1:length(C)&#xA;%          b_array(:,:,n) = tf([K*R2*C(n) K],[K*R2*C(n) 1]);&#xA;%       end&#xA;&#xA;opampdemo_aux(19)&#xA;&#xA;%%&#xA;% Now you can create LTI arrays for A(s) and L(s):&#xA;% &#xA;%  &gt;&gt; A_array = feedback(a,b_array);&#xA;%  &gt;&gt; L_array = a*b_array;&#xA;%  &#xA;% You can plot the step response of all models in the LTI array,&#xA;% A_array(s), together with A(s) using the STEP command:&#xA;% &#xA;%  &gt;&gt; step(A,'b:',A_array,'b');&#xA;&#xA;opampdemo_aux(20)&#xA;&#xA;%%&#xA;% The phase margins for our loop gain array, L_array(s), are found&#xA;% using the MARGIN command:&#xA;%  &#xA;%  &gt;&gt; [Gm,Pm,Wcg,Wcp] = margin(L_array);&#xA;%  &#xA;% The phase margins may now be plotted as a function of C:&#xA;% &#xA;%  &gt;&gt; plot(C*1e12,Pm,'g');&#xA;% &#xA;% A maximum phase margin of 58 deg is obtained when C=2pF (2e-12).&#xA;&#xA;opampdemo_aux(21)&#xA;&#xA;%%&#xA;% The model corresponding to C=2pF is the sixth model in the LTI&#xA;% array, b_array(s).  You can plot the step response of the closed-&#xA;% loop system for this model by selecting index 6 of the LTI array&#xA;% A_array(s):&#xA;% &#xA;%  &gt;&gt; A_comp = A_array(:,:,6);&#xA;%  &gt;&gt; step(A,'b:',A_comp,'b')&#xA;%  &#xA;% Note that the settling time has been further reduced (by an&#xA;% additional 85%).&#xA;&#xA;opampdemo_aux(22)&#xA;&#xA;%%&#xA;% We can overlay the frequency-response of all three models&#xA;% (open-loop, closed-loop,compensated closed-loop) using the&#xA;% BODE command:&#xA;% &#xA;%  &gt;&gt; bode(a,'r',A,'b:',A_comp,'b')&#xA;%  &#xA;% Note how the addition of the compensation capacitor has&#xA;% eliminated peaking in the closed-loop gain and also greatly&#xA;% extended the phase margin.&#xA;&#xA;opampdemo_aux(23)&#xA;&#xA;%%&#xA;% A brief summary of the choice of component values in the design&#xA;% of this non-inverting feedback amplifier circuit:&#xA;% &#xA;% * A resistive feedback network (R1,R2) was selected to yield a&#xA;%    broadband amplifier gain of 10 (20 dB).&#xA;% &#xA;% * Feedback lead compensation was used to tune the loop gain near&#xA;%    near the crossover frequency.  The value for the compensation&#xA;%    capacitor, C, was optimized to provide a maximum phase margin&#xA;%    of about 58 degrees.&#xA;&#xA;opampdemo_aux(24)&#xA;&#xA;&#xA;"></originalCode>