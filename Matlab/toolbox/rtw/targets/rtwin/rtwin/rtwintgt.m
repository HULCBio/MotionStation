function rtwintgt(command, noprompt)
%RTWINTGT Install and remove the Real-Time Windows Target kernel.
%
%  The Real-Time Windows Target is a package that allows you to run C code
%  generated by Real-Time Workshop on a PC in real time. Please refer to 
%  the Real-Time Windows Target documentation for more information.
%
%  Available options are:
%  -setup           Install Real-Time Windows Target kernel on your system.
%  -install         Same as -setup.
%  -uninstall       Remove Real-Time Windows Target kernel from your system.
%  -forceuninstall  Forcibly remove Real-Time Windows Target kernel from your system.
%  -version         Display the kernel version currently installed.

%   Copyright 1994-2003 The MathWorks, Inc.
%   $Revision: 1.14.2.5 $  $Date: 2003/12/31 19:46:07 $  $Author: batserve $

if nargin<1
  help rtwintgt;
else

  if nargin<2
    noprompt = 0;
  end
    
  switch (command)
  case '-setup'
    rtwt_setup(noprompt);
  case '-install'
    rtwt_setup(noprompt);
  case '-uninstall'
    rtwt_uninstall(noprompt);
  case '-forceuninstall'
    rtwt_forceuninstall(noprompt);
  case '-version'
    rtwt_version;
  otherwise
    error('RTWIN:invalidinarg','Unrecognized option.');
  end
end


%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% RTWT_SETUP
%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function rtwt_setup(noprompt)

% first ask for confirmation

disp(' ');

if (noprompt)
  yesno = 'Y';
else
  switch rtwtinst('getversion');
    case 250;
      disp('The current version of the Real-Time Windows Target kernel is already installed.');
      yesno = input('Do you want to reinstall it? [n] : ', 's');
      if isempty(yesno)
        yesno='n';
      end
      reinstmsg = 'reinstall';
    case 0;
      disp('You are going to install the Real-Time Windows Target kernel.');
      yesno = input('Do you want to proceed? [y] : ', 's');
      if isempty(yesno)
        yesno='y';
      end
      reinstmsg = 'install';
    otherwise;
      disp('There is a different version of the Real-Time Windows Target kernel installed.');
      yesno = input('Do you want to update to the current version? [y] : ', 's');
      if isempty(yesno)
        yesno='y';
      end
      reinstmsg = 'updat';
  end
end

if upper(yesno(1)) ~= 'Y'
  disp(['The Real-Time Windows Target kernel has not been ' reinstmsg 'ed.']);
  disp(' ');
  return;
end

% check if CPU is ok for the installation

if ~rtwtinst('iscpuok')
  disp('The Real-Time Windows Target requires Pentium or better processor.');
  disp('Installation cannot continue.');
  disp(' ');
  return;
end

% try to stop any kernel activity - if kernel not installed, this fails, so we catch the error

try
  rtclear;
  rtunload;
catch
end

% clearing the gateway MEX file is necessary for installation on Windows NT

if rtwtinst('getplatform')==1
  clear rtwinext;
  [dummy,mex]=inmem;  %#ok DUMMY is dummy
  if ~isempty(findstr([mex{:}], 'rtwinext'))
    disp('The Real-Time Windows Target kernel is currently being used.');
    disp('Please quit and restart MATLAB, then repeat the installation.');
    disp(' ');
    return;
  end
end

% do the installation

srcpath = fileparts(which('rtwinext'));
srcpath = [srcpath(1:find(srcpath==filesep,1,'last')) 'kernel' filesep];
reboot = rtwtinst('install', srcpath);

% reboot if necessary

if (reboot)
  disp('You must reboot your machine to finish the installation.');
  if (~noprompt)
    yesno = input('Do you want to reboot now? [n] : ', 's');
    if ~isempty(yesno) && upper(yesno(1)) == 'Y'
      rtwtinst('reboot');
    end
  end
else
  disp('The Real-Time Windows Target kernel has been successfully installed.');
  disp(' ');
end



%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% RTWT_UNINSTALL
%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function rtwt_uninstall(noprompt)

% first ask for confirmation

disp(' ');
if rtwtinst('getversion')==0
  disp('There is no Real-Time Windows Target kernel installed.');
  if (~noprompt)
    yesno = input('Do you want to do the uninstallation anyway? [n] : ', 's');
    if isempty(yesno)
      yesno='n';
    end
  else
    yesno='n';
  end
else
  disp('You are going to uninstall the Real-Time Windows Target kernel.');
  if (~noprompt)
    yesno = input('Do you want to proceed? [y] : ', 's');
    if isempty(yesno)
      yesno='y';
    end
  else
    yesno='y';
  end
end

if upper(yesno(1)) ~= 'Y'
  disp('The Real-Time Windows Target kernel has not been uninstalled.');
  disp(' ');
  return;
end

% try to stop any kernel activity - if kernel not installed, this fails, so we catch the error

try
  rtclear;
  rtunload;
catch
end

% clearing the gateway MEX file is necessary for uninstallation on Windows NT

if rtwtinst('getplatform')==1
  clear rtwinext;
  [dummy,mex]=inmem;  %#ok DUMMY is dummy
  if ~isempty(findstr([mex{:}], 'rtwinext'))
    disp('The Real-Time Windows Target kernel is currently being used.');
    disp('Please quit and restart MATLAB, then repeat the uninstallation.');
    disp(' ');
    return;
  end
end

% do the uninstallation

reboot = rtwtinst('uninstall');

% reboot if necessary

if (reboot)
  disp('You must reboot your machine to finish the uninstallation.');
  if (~noprompt)
    yesno = input('Do you want to reboot now? [n] : ', 's');
    if ~isempty(yesno) && upper(yesno(1)) == 'Y'
      rtwtinst('reboot');
    end
  end
else
  disp('The Real-Time Windows Target kernel has been successfully uninstalled.');
  disp(' ');
end



%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% RTWT_FORCEUNINSTALL
%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function rtwt_forceuninstall(noprompt)

% first ask for confirmation

disp(' ');
disp('You are going to forcibly uninstall the Real-Time Windows Target kernel.');
if (~noprompt)
  yesno = input('Do you want to proceed? [n] : ', 's');
  if isempty(yesno)
    yesno='y';
  end
else
  yesno='y';
end

if upper(yesno(1)) ~= 'Y'
  disp('The Real-Time Windows Target kernel has not been forcibly uninstalled.');
  disp(' ');
  return;
end

% do the uninstallation

reboot = rtwtinst('forceuninstall');

% reboot if necessary

if (reboot)
  disp('You must reboot your machine to finish the forcible uninstallation.');
  if (~noprompt)
    yesno = input('Do you want to reboot now? [n] : ', 's');
    if ~isempty(yesno) && upper(yesno(1)) == 'Y'
      rtwtinst('reboot');
    end
  end
else
  disp('The Real-Time Windows Target kernel has been forcibly uninstalled.');
  disp(' ');
end



%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% RTWT_VERSION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function rtwt_version

disp(' ');
v = rtwtinst('getversion');
if v==0
  disp('There is no Real-Time Windows Target kernel installed.');
else
  disp(sprintf('The installed version of the Real-Time Windows Target kernel is %.0f.%.1f.', fix(v/100),rem(v,100)/10));
end
disp(' ');
